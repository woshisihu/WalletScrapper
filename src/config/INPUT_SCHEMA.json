const Apify = require('apify');
const { PuppeteerLauncher } = require('apify-shared/puppeteer');

Apify.main(async () => {
  const input = await Apify.getInput();
  const targetUrls = input.targetUrls || [
    "https://gmgn.ai/trade/CTalgv8F?chain=sol&tab=smart_degen",
    "https://gmgn.ai/trade/CTalgv8F?chain=sol&tab=live",
    "https://gmgn.ai/trade/CTalgv8F?chain=sol&tab=top_followed"
  ];
  const maxItemsPerTab = input.maxItemsPerTab || 50;

  const browser = await Apify.launchPuppeteer();  // 或用 stealth plugin
  const page = await browser.newPage();

  const allData = [];  // 收集所有 tab 的数据

  for (const url of targetUrls) {
    console.log(`Scraping: ${url}`);
    await page.goto(url, { waitUntil: 'networkidle2', timeout: 60000 });

    // 根据 tab 类型自定义 selector（需你 inspect 页面实际 DOM）
    let items = [];
    if (url.includes('tab=smart_degen')) {
      // 示例：刮 smart degen 列表的 wallet cards
      items = await page.$$eval('.smart-degen-card, .trader-item', els => 
        els.map(el => ({
          address: el.querySelector('.wallet-address')?.textContent.trim(),
          pnl: el.querySelector('.pnl-value')?.textContent.trim(),
          // 其他字段...
        })).filter(item => item.address)
      );
    } else if (url.includes('tab=live')) {
      // live tab 可能刮实时交易中的 buyer/seller 地址
      items = await page.$$eval('.live-trade-row', els => 
        els.map(el => ({
          address: el.querySelector('.trader-address')?.textContent.trim(),
          action: el.querySelector('.action')?.textContent.trim(),
        })).filter(item => item.address)
      );
    } else if (url.includes('tab=top_followed')) {
      // top_followed tab 刮跟随者榜
      items = await page.$$eval('.followed-wallet-row, .copy-trader-item', els => 
        els.map(el => ({
          address: el.querySelector('.wallet-address')?.textContent.trim(),
          followers: el.querySelector('.followers-count')?.textContent.trim(),
          // ...
        })).filter(item => item.address)
      );
    }

    // 限量
    items = items.slice(0, maxItemsPerTab);

    allData.push({
      url,
      tab: url.split('tab=')[1] || 'unknown',
      items
    });

    // 可加延时避免检测
    await Apify.utils.sleep(2000 + Math.random() * 3000);
  }

  await browser.close();

  // 输出到 Apify Dataset
  await Apify.pushData(allData);

  console.log(`Scraped ${allData.reduce((sum, d) => sum + d.items.length, 0)} items total.`);
});
